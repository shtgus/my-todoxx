<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Mytodo</title>

<style>
/* ===== 你的原始样式，未改 ===== */
:root {
  --bg:#F5F7FA;--card:#FFF;--text-main:#334155;--text-sec:#64748B;
  --morandi-red:#E08E8E;--morandi-red-light:#FDF2F2;
  --border:#E5E7EB;--shadow:0 4px 20px rgba(0,0,0,0.04);
  --radius:20px;
}
body{margin:0;height:100vh;display:flex;background:var(--bg);font-family:PingFang SC,Inter,sans-serif}
.app-shell{display:grid;grid-template-columns:280px 1fr 320px;gap:24px;width:100%;padding:24px;box-sizing:border-box}
.panel{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
button{background:var(--morandi-red);color:#fff;border:none;border-radius:10px;padding:8px 16px;cursor:pointer}
.btn-ghost{background:#F1F5F9;color:var(--text-sec)}
.scroll{overflow-y:auto}
.scroll::-webkit-scrollbar{display:none}
.todo-item{border-bottom:1px solid #F1F5F9}
.todo-main{display:flex;align-items:center;padding:16px;cursor:pointer}
.todo-main:hover{background:#FAFBFC}
.todo-details{max-height:0;overflow:hidden;transition:.3s;background:#FBFCFD}
.todo-item.active .todo-details{max-height:400px;padding:16px;border-top:1px solid #EEE}
</style>
</head>

<body>
<div class="app-shell">
  <div class="panel" style="padding:24px">
    <div id="live-time" style="font-size:1.8rem;color:var(--morandi-red)"></div>
    <div id="live-date" style="font-size:.85rem;color:var(--text-sec)"></div>
  </div>

  <div class="panel scroll" id="list-container"></div>

  <div class="panel" style="padding:24px">
    <input id="t-input" placeholder="输入任务，回车创建"
      onkeydown="if(event.keyCode===13)addTask()"
      style="padding:10px;border-radius:8px;border:1px solid #DDD">
  </div>
</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ================= Supabase 配置 ================= */
const supabase = supabaseJs.createClient(
  "https://jmkbmedqxcjefmnygyby.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impta2JtZWRxeGNqZWZtbnlneWJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNjEyMTgsImV4cCI6MjA4NTYzNzIxOH0.x2BbeuxwPe8MEop7hzvZo0fZ9LRmNm3Jj5JgAA0MzXQ"
)

/* ================= 登录（只需一次） ================= */
async function getUser() {
  const { data } = await supabase.auth.getSession()
  if (data.session) return data.session.user

  const email = prompt("请输入邮箱，用于同步 Todo（仅第一次）")
  if (!email) return null

  await supabase.auth.signInWithOtp({ email })
  alert("已发送登录邮件，点开后刷新页面")
  return null
}

/* ================= 数据 ================= */
let tasks = []

/* ================= 加载云端数据 ================= */
async function loadTasks() {
  const user = await getUser()
  if (!user) return

  const { data } = await supabase
    .from("tasks")
    .select("*")
    .eq("user_id", user.id)
    .order("created_at")

  tasks = data || []
  render()
}

/* ================= 新建任务 ================= */
async function addTask() {
  const input = document.getElementById("t-input")
  if (!input.value.trim()) return

  const user = await getUser()
  if (!user) return

  const { data } = await supabase
    .from("tasks")
    .insert([{
      user_id: user.id,
      name: input.value,
      done: false
    }])
    .select()

  tasks.push(data[0])
  input.value = ""
  render()
}

/* ================= 完成 / 删除 ================= */
async function toggleDone(id) {
  const t = tasks.find(x => x.id === id)
  t.done = !t.done
  await supabase.from("tasks").update({ done: t.done }).eq("id", id)
  render()
}

async function delTask(id) {
  tasks = tasks.filter(x => x.id !== id)
  await supabase.from("tasks").delete().eq("id", id)
  render()
}

/* ================= 渲染 ================= */
function render() {
  const box = document.getElementById("list-container")
  box.innerHTML = ""
  tasks.forEach(t => {
    const d = document.createElement("div")
    d.className = "todo-item"
    d.innerHTML = `
      <div class="todo-main">
        <input type="checkbox" ${t.done?"checked":""}
          onclick="toggleDone('${t.id}')">
        <span style="margin-left:10px;${t.done?'text-decoration:line-through;opacity:.4':''}">
          ${t.name}
        </span>
        <button style="margin-left:auto"
          onclick="delTask('${t.id}')">删</button>
      </div>
    `
    box.appendChild(d)
  })
}

/* ================= 时钟 ================= */
function updateClock() {
  const n = new Date()
  live-time.innerText = n.toLocaleTimeString("zh-CN",{hour:'2-digit',minute:'2-digit'})
  live-date.innerText = n.toLocaleDateString("zh-CN",{weekday:'long',month:'long',day:'numeric'})
}

/* ================= 启动 ================= */
updateClock()
setInterval(updateClock,1000)
loadTasks()
</script>
</body>
</html>
