<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Mydotoxxx</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #F5F7FA; --card: #FFFFFF; --text-main: #334155; --text-sec: #64748B;
            --morandi-red: #E08E8E; --morandi-red-light: #FDF2F2; --border: #E5E7EB;
            --shadow: 0 4px 20px rgba(0,0,0,0.04); --radius: 20px;
        }
        body { font-family: 'PingFang SC', system-ui; background: var(--bg); color: var(--text-main); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ÂêåÊ≠•Áä∂ÊÄÅÊù° */
        .sync-banner { background: #334155; color: white; padding: 6px 24px; display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; z-index: 100; }
        .sync-banner input { background: rgba(255,255,255,0.1); border: 1px solid #555; color: white; border-radius: 4px; padding: 2px 8px; outline: none; transition: 0.3s; width: 120px; }
        .sync-banner input:focus { background: rgba(255,255,255,0.2); width: 180px; }

        .app-shell { display: grid; grid-template-columns: 280px 1fr 320px; gap: 24px; flex: 1; padding: 24px; box-sizing: border-box; overflow: hidden; }
        .panel { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--border); }
        
        /* ÂàóË°®Ê†∑Âºè */
        .todo-item { border-bottom: 1px solid #F1F5F9; }
        .todo-main { display: flex; align-items: center; padding: 16px; cursor: pointer; transition: 0.2s; }
        .todo-main:hover { background: #FAFBFC; }
        .todo-details { max-height: 0; overflow: hidden; transition: 0.3s; background: #FBFCFD; }
        .todo-item.active .todo-details { max-height: 400px; padding: 16px; border-top: 1px solid #EEE; }
        
        /* Ê†áÁ≠æ */
        .tag-pill { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; background: #F1F5F9; border: 1px solid transparent; }
        .tag-pill.active { border-color: currentColor; background: white; font-weight: bold; }

        /* ËæìÂÖ•Âå∫ */
        .input-area { background: white; padding: 16px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 24px; }
        .input-row { display: flex; gap: 12px; align-items: center; margin-bottom: 12px; }
        .input-row input[type="text"] { flex: 1; border: none; outline: none; font-size: 1rem; }

        button { background: var(--morandi-red); color: white; border: none; padding: 8px 16px; border-radius: 10px; cursor: pointer; }
        .btn-ghost { background: #F1F5F9; color: var(--text-sec); }
        .scroll { overflow-y: auto; scrollbar-width: none; }
        textarea { width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 10px; font-size: 0.85rem; resize: none; outline: none; box-sizing: border-box; }
        
        #timer-val { font-size: 3.5rem; font-weight: 200; color: var(--morandi-red); text-align: center; }
    </style>
</head>
<body>

<div class="sync-banner">
    <div>‚òÅÔ∏è ‰∫ëÁ´ØÁä∂ÊÄÅ: <span id="sync-status">Êú¨Âú∞Â≠òÂÇ®‰∏≠</span></div>
    <div>
        ÂêåÊ≠•Âè£‰ª§: <input type="password" id="sync-code" placeholder="ËæìÂÖ•Âè£‰ª§ÂêåÊ≠•" onblur="initSupabase()">
        <span id="last-sync" style="margin-left:12px; opacity:0.6"></span>
    </div>
</div>

<div class="app-shell">
    <div class="panel">
        <div style="padding: 24px; border-bottom: 1px solid #F1F5F9;">
            <div id="live-time" style="font-size: 1.8rem; font-weight: 300; color: var(--morandi-red);"></div>
            <div id="live-date" style="color: var(--text-sec); font-size: 0.85rem;"></div>
        </div>
        <div class="nav-group" style="padding-top:20px;">
            <div class="nav-item active" style="padding:12px 24px; cursor:pointer">‰ªäÊó•Ê∏ÖÂçï</div>
        </div>
    </div>

    <div style="display: flex; flex-direction: column;">
        <div class="input-area">
            <div class="input-row">
                <input type="text" id="t-input" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑÁõÆÊ†á..." onkeydown="if(event.keyCode==13) addTask()">
                <input type="date" id="t-date">
            </div>
            <div id="tag-selector" style="display:flex; gap:8px; margin-bottom:12px;"></div>
            <div style="display:flex; gap:8px; border-top:1px solid #EEE; padding-top:10px;">
                <input type="text" id="new-tag-name" placeholder="Êñ∞Ê†áÁ≠æ" style="width:70px; font-size:0.7rem;">
                <input type="color" id="new-tag-color" value="#E08E8E">
                <button onclick="createNewTag()" style="font-size:0.7rem; padding:2px 10px;">Ê∑ªÂä†Ê†áÁ≠æ</button>
            </div>
        </div>
        <div class="panel scroll" style="flex: 1;" id="list-container"></div>
    </div>

    <div class="panel" style="padding:24px;">
        <div id="timer-val">25:00</div>
        <button onclick="togglePomo()" style="width:100%; margin-top:20px;">ÂºÄÂßã‰∏ìÊ≥®</button>
        <div style="margin-top:40px;">
            <div style="font-weight:bold; color:var(--morandi-red);">üê¢ Êµ∑ÈæüÊ±§</div>
            <p id="soup-f" style="font-size:0.85rem; line-height:1.6;"></p>
        </div>
    </div>
</div>

<script>
    // --- 1. ÈÖçÁΩÆÂå∫ (ËØ∑Â°´ÂÜô‰Ω†ÁöÑ‰ø°ÊÅØ) ---
    const SB_URL = 'https://jmkbmedqxcjefmnygyby.supabase.co'; 
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // Â°´ÂÖ•‰Ω†ÂàöÊâçÂ§çÂà∂ÁöÑÈïø Key
    let supabase = null;

    // --- 2. Ê†∏ÂøÉÊï∞ÊçÆ ---
    let tasks = JSON.parse(localStorage.getItem('tasks_v8')) || [];
    let tags = JSON.parse(localStorage.getItem('tags_v8')) || [{id:'t1', name:'Â∑•‰Ωú', color:'#E08E8E'}];
    let selectedTagId = 't1';
    let pomoCount = 0;

    // --- 3. ‰∫ëÂêåÊ≠•ÈÄªËæë ---
    async function initSupabase() {
        const code = document.getElementById('sync-code').value;
        if(!code) return;
        supabase = supabasejs.createClient(SB_URL, SB_KEY);
        document.getElementById('sync-status').innerText = 'Ê≠£Âú®ÂêåÊ≠•...';

        const { data, error } = await supabase.from('focus_data').select('*').eq('sync_code', code).single();
        if(data) {
            tasks = data.tasks; tags = data.tags; pomoCount = data.pomo;
            saveLocally(); render(); renderTags();
            document.getElementById('sync-status').innerText = '‰∫ëÁ´ØÂêåÊ≠•Â∑≤ÂºÄÂêØ';
        } else {
            document.getElementById('sync-status').innerText = 'Êñ∞Âè£‰ª§Â∑≤Â∞±Áª™';
        }
    }

    async function save() {
        saveLocally(); render();
        const code = document.getElementById('sync-code').value;
        if(!supabase || !code) return;

        const { error } = await supabase.from('focus_data').upsert({
            sync_code: code, tasks: tasks, tags: tags, pomo: pomoCount
        });
        if(!error) document.getElementById('last-sync').innerText = 'ÂêåÊ≠•‰∫é ' + new Date().toLocaleTimeString();
    }

    function saveLocally() {
        localStorage.setItem('tasks_v8', JSON.stringify(tasks));
        localStorage.setItem('tags_v8', JSON.stringify(tags));
    }

    // --- 4. ‰∏öÂä°ÈÄªËæë (Âêå V6) ---
    function renderTags() {
        const container = document.getElementById('tag-selector');
        container.innerHTML = tags.map(t => `
            <span class="tag-pill ${selectedTagId===t.id?'active':''}" style="color:${t.color}" onclick="selectedTagId='${t.id}';renderTags()">
                ${t.name}
            </span>`).join('');
    }

    function createNewTag() {
        const name = document.getElementById('new-tag-name').value;
        const color = document.getElementById('new-tag-color').value;
        if(!name) return;
        tags.push({id:'t'+Date.now(), name, color});
        save(); renderTags();
    }

    function addTask() {
        const input = document.getElementById('t-input');
        if(!input.value) return;
        tasks.push({id:Date.now(), name:input.value, date:document.getElementById('t-date').value, tagId:selectedTagId, desc:'', done:false});
        input.value = ''; save();
    }

    function render() {
        const container = document.getElementById('list-container');
        container.innerHTML = '';
        tasks.forEach(t => {
            const tag = tags.find(x => x.id === t.tagId) || {color:'#CCC'};
            const div = document.createElement('div');
            div.className = 'todo-item';
            div.innerHTML = `
                <div class="todo-main" onclick="this.parentElement.classList.toggle('active')">
                    <input type="checkbox" ${t.done?'checked':''} onclick="event.stopPropagation(); t.done=!t.done; save();">
                    <div style="flex:1; margin-left:12px; border-left:4px solid ${tag.color}; padding-left:10px;">
                        <div style="${t.done?'text-decoration:line-through;opacity:0.5':''}">${t.name}</div>
                        <small style="color:#94A3B8">${t.date||'ÈöèÊó∂'}</small>
                    </div>
                </div>
                <div class="todo-details">
                    <textarea placeholder="Â§áÊ≥®..." onblur="updateTask(${t.id}, 'desc', this.value)">${t.desc||''}</textarea>
                    <div style="margin-top:10px; display:flex; gap:10px;">
                        <input type="date" value="${t.date}" onchange="updateTask(${t.id}, 'date', this.value)" style="flex:1">
                        <button onclick="delTask(${t.id})" style="background:#FEE2E2; color:red;">Âà†Èô§</button>
                    </div>
                </div>`;
            container.appendChild(div);
        });
    }

    function updateTask(id, k, v) { const t = tasks.find(x=>x.id===id); if(t) t[k]=v; save(); }
    function delTask(id) { tasks = tasks.filter(x=>x.id!==id); save(); }

    // ÂàùÂßãÂåñÊó∂Èíü
    setInterval(() => { document.getElementById('live-time').innerText = new Date().toLocaleTimeString(); }, 1000);
    render(); renderTags();
</script>
</body>
</html>
