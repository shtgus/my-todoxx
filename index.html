<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∏ìÊ≥®Ê∏ÖÂçï Pro - ÊúÄÁªà‰øÆÂ§çÁâà</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #F5F7FA; --card: #FFFFFF; --text-main: #334155; --text-sec: #64748B;
            --morandi-red: #E08E8E; --morandi-red-light: #FDF2F2; --border: #E5E7EB;
            --shadow: 0 4px 20px rgba(0,0,0,0.04); --radius: 20px;
        }
        body { font-family: 'PingFang SC', system-ui, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .sync-banner { background: #334155; color: white; padding: 6px 24px; display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; z-index: 1000; }
        .sync-banner input { background: rgba(255,255,255,0.1); border: 1px solid #555; color: white; border-radius: 4px; padding: 2px 8px; outline: none; width: 120px; }
        .app-shell { display: grid; grid-template-columns: 280px 1fr 320px; gap: 24px; flex: 1; padding: 24px; box-sizing: border-box; overflow: hidden; }
        .panel { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--border); }
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: #fff; padding: 18px; border-radius: 16px; text-align: center; border: 1px solid var(--border); }
        .stat-val { font-size: 1.4rem; font-weight: 700; color: var(--morandi-red); }
        .input-area { background: white; padding: 16px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 24px; }
        .input-row { display: flex; gap: 12px; align-items: center; margin-bottom: 12px; }
        .input-row input[type="text"] { flex: 1; border: none; outline: none; font-size: 1rem; background: transparent; }
        .tag-pill { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; border: 1px solid transparent; background: #F1F5F9; margin-right: 5px; }
        .tag-pill.active { border-color: currentColor; background: white; font-weight: bold; }
        .todo-item { border-bottom: 1px solid #F1F5F9; }
        .todo-main { display: flex; align-items: center; padding: 16px; cursor: pointer; }
        .todo-details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; background: #FBFCFD; }
        .todo-item.active .todo-details { max-height: 400px; padding: 16px; border-top: 1px solid #EEE; }
        .nav-item { padding: 12px 20px; margin: 4px 16px; cursor: pointer; border-radius: 12px; font-size: 0.9rem; color: var(--text-sec); }
        .nav-item.active { background: var(--morandi-red-light); color: var(--morandi-red); font-weight: 600; }
        .cal-day { height: 32px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; font-size: 0.7rem; }
        .cal-pop { position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background: #334155; color: white; padding: 8px; border-radius: 8px; width: 120px; visibility: hidden; opacity: 0; z-index: 100; }
        .cal-day:hover .cal-pop { visibility: visible; opacity: 1; }
        .scroll { overflow-y: auto; scrollbar-width: none; }
        .scroll::-webkit-scrollbar { display: none; }
        button { cursor: pointer; border: none; transition: 0.2s; }
        button:active { transform: scale(0.95); }
    </style>
</head>
<body>

<div class="sync-banner">
    <div>Áä∂ÊÄÅ: <span id="sync-status">Á¶ªÁ∫øÊ®°Âºè</span></div>
    <div>
        ÂêåÊ≠•Âè£‰ª§: <input type="password" id="sync-code" placeholder="ËæìÂÖ•Âè£‰ª§ÂêåÊ≠•" onblur="trySync()">
        <span id="cloud-info" style="margin-left:10px; opacity:0.7"></span>
    </div>
</div>

<div class="app-shell">
    <div class="panel">
        <div style="padding: 24px; border-bottom: 1px solid #F1F5F9;">
            <div id="live-time" style="font-size: 1.8rem; font-weight: 300; color: var(--morandi-red);">00:00</div>
            <div id="live-date" style="color: var(--text-sec); font-size: 0.85rem;">Âä†ËΩΩ‰∏≠...</div>
        </div>
        <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); padding: 15px;"></div>
        <div class="nav-group">
            <div class="nav-item active" onclick="setFilter('today', this)">‰ªäÊó•Ê∏ÖÂçï</div>
            <div class="nav-item" onclick="setFilter('all', this)">ÂÖ®ÈÉ®‰ªªÂä°</div>
        </div>
    </div>

    <div style="display: flex; flex-direction: column;">
        <div class="stats-bar">
            <div class="stat-card"><div id="stat-progress" class="stat-val">0%</div><div style="font-size:0.7rem;">‰ªäÊó•ËøõÂ∫¶</div></div>
            <div class="stat-card"><div id="stat-pending" class="stat-val">0</div><div style="font-size:0.7rem;">ÂæÖÂäû</div></div>
            <div class="stat-card"><div id="stat-focus" class="stat-val">0</div><div style="font-size:0.7rem;">Áï™ËåÑ</div></div>
        </div>
        <div class="input-area">
            <div class="input-row">
                <input type="text" id="t-input" placeholder="ËæìÂÖ•‰ªªÂä°ÊåâÂõûËΩ¶...">
                <input type="date" id="t-date">
            </div>
            <div id="tag-selector" style="margin-bottom:10px;"></div>
            <button onclick="addTask()" style="background:var(--morandi-red); color:white; padding:5px 15px; border-radius:8px;">Ê∑ªÂä†‰ªªÂä°</button>
        </div>
        <div class="panel scroll" style="flex: 1;" id="list-container"></div>
    </div>

    <div style="display: flex; flex-direction: column; gap: 24px;">
        <div class="panel" style="padding:20px; text-align:center;">
            <div id="timer-val" style="font-size:3rem; color:var(--morandi-red);">25:00</div>
            <button onclick="togglePomo()" id="p-btn" style="width:100%; padding:10px; background:var(--morandi-red); color:white; border-radius:10px; margin-top:10px;">ÂºÄÂßã</button>
        </div>
        <div class="panel scroll" style="flex: 1; padding: 20px;">
            <div style="font-weight: bold; color: var(--morandi-red);">üê¢ Êµ∑ÈæüÊ±§</div>
            <div id="soup-f" style="font-size: 0.85rem; margin-top:10px;"></div>
            <button onclick="nextSoup()" style="margin-top:10px; width:100%; background:#F1F5F9; color:var(--text-sec); border-radius:8px; padding:5px;">Êç¢‰∏ÄÁ¢ó</button>
        </div>
    </div>
</div>

<script>
    // --- 1. ÈÖçÁΩÆ (ËØ∑Â°´ÂÖ•‰Ω†ÁöÑ‰ø°ÊÅØ) ---
    const SB_URL = 'https://jmkbmedqxcjefmnygyby.supabase.co'; 
    const SB_KEY = 'YOUR_ANON_KEY_HERE'; 
    let supabaseClient = null;

    // --- 2. Áä∂ÊÄÅÂèòÈáè ---
    let tasks = JSON.parse(localStorage.getItem('tasks_v87')) || [];
    let tags = [{id:'t1', name:'ÈªòËÆ§', color:'#E08E8E'}];
    let pomoCount = 0;
    let currentFilter = 'today';
    let pTime = 1500, pInt = null;

    // --- 3. Ê†∏ÂøÉÂàùÂßãÂåñ (Èò≤Ê≠¢Â§±ÊïàÁöÑÂÖ≥ÈîÆ) ---
    window.onload = function() {
        console.log("App Initialized");
        updateClock();
        setInterval(updateClock, 1000);
        render();
        renderTags();
        nextSoup();
        
        // ÁªëÂÆöÂõûËΩ¶‰∫ã‰ª∂
        document.getElementById('t-input').onkeydown = (e) => { if(e.keyCode==13) addTask(); };
    };

    // --- 4. ‰∫ëÂêåÊ≠•ÈÄªËæë (‰øÆÊ≠£ËØ≠Ê≥ï) ---
    async function trySync() {
        const code = document.getElementById('sync-code').value;
        if (!code || typeof supabase === 'undefined') return;
        
        try {
            supabaseClient = supabase.createClient(SB_URL, SB_KEY);
            document.getElementById('sync-status').innerText = 'Ê≠£Âú®ÂêåÊ≠•...';
            const { data, error } = await supabaseClient.from('focus_data').select('*').eq('sync_code', code).single();
            if (data) {
                tasks = data.tasks || [];
                pomoCount = data.pomo || 0;
                saveLocally(); render();
                document.getElementById('sync-status').innerText = 'Â∑≤ËøûÊé•‰∫ëÁ´Ø';
            } else {
                document.getElementById('sync-status').innerText = 'Êñ∞Âè£‰ª§Â∑≤ÂàõÂª∫';
                save();
            }
        } catch(e) { console.error("Sync Error:", e); }
    }

    async function save() {
        saveLocally();
        render();
        const code = document.getElementById('sync-code').value;
        if (!supabaseClient || !code) return;
        await supabaseClient.from('focus_data').upsert({ sync_code: code, tasks: tasks, pomo: pomoCount });
        document.getElementById('cloud-info').innerText = 'ÂêåÊ≠•ÂÆåÊàê';
    }

    function saveLocally() {
        localStorage.setItem('tasks_v87', JSON.stringify(tasks));
    }

    // --- 5. UI Ê∏≤ÊüìÂáΩÊï∞ ---
    function updateClock() {
        const now = new Date();
        document.getElementById('live-time').innerText = now.toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});
        document.getElementById('live-date').innerText = now.toLocaleDateString('zh-CN', {weekday:'long', month:'long', day:'numeric'});
    }

    function renderTags() {
        const container = document.getElementById('tag-selector');
        container.innerHTML = tags.map(t => `<span class="tag-pill active" style="color:${t.color}">${t.name}</span>`).join('');
    }

    function addTask() {
        const input = document.getElementById('t-input');
        if(!input.value.trim()) return;
        tasks.push({id:Date.now(), name:input.value, date:document.getElementById('t-date').value, done:false, desc:''});
        input.value = ''; save();
    }

    function render() {
        const container = document.getElementById('list-container');
        container.innerHTML = '';
        const todayStr = new Date().toISOString().split('T')[0];

        const filtered = tasks.filter(t => {
            if (currentFilter === 'today') return t.date === todayStr || (!t.done && t.date < todayStr);
            return true;
        });

        filtered.forEach(t => {
            const div = document.createElement('div');
            div.className = 'todo-item';
            div.innerHTML = `
                <div class="todo-main" onclick="this.parentElement.classList.toggle('active')">
                    <input type="checkbox" ${t.done?'checked':''} onclick="event.stopPropagation(); toggleTask(${t.id})">
                    <div style="flex:1; margin-left:10px; ${t.done?'text-decoration:line-through;opacity:0.5':''}">
                        <div>${t.name}</div>
                        <small style="color:#94A3B8">${t.date || 'ÈöèÊó∂'}</small>
                    </div>
                    <button onclick="event.stopPropagation(); delTask(${t.id})" style="background:none; color:red; font-size:0.7rem;">Âà†Èô§</button>
                </div>
                <div class="todo-details">
                    <textarea style="width:100%;" onblur="updateTask(${t.id}, this.value)">${t.desc||''}</textarea>
                </div>`;
            container.appendChild(div);
        });

        // ÁªüËÆ°
        document.getElementById('stat-pending').innerText = tasks.filter(x=>!x.done).length;
        document.getElementById('stat-focus').innerText = pomoCount;
        renderCalendar();
    }

    function renderCalendar() {
        const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
        const days = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
        for(let i=1; i<=days; i++) {
            grid.innerHTML += `<div class="cal-day">${i}</div>`;
        }
    }

    // --- 6. ÂäüËÉΩÂáΩÊï∞ ---
    function toggleTask(id) { const t = tasks.find(x=>x.id===id); t.done=!t.done; save(); }
    function delTask(id) { tasks = tasks.filter(x=>x.id!==id); save(); }
    function updateTask(id, val) { const t = tasks.find(x=>x.id===id); t.desc=val; save(); }
    function setFilter(f, el) { currentFilter=f; document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active')); el.classList.add('active'); render(); }
    
    function togglePomo() {
        if(pInt) { clearInterval(pInt); pInt=null; document.getElementById('p-btn').innerText="ÁªßÁª≠"; }
        else { 
            pInt = setInterval(() => { pTime--; updatePDisp(); if(pTime<=0){ clearInterval(pInt); pomoCount++; save(); alert("‰∏ìÊ≥®ÂÆåÊàê"); pTime=1500; updatePDisp(); } }, 1000); 
            document.getElementById('p-btn').innerText="ÊöÇÂÅú";
        }
    }
    function updatePDisp() { const m=Math.floor(pTime/60), s=pTime%60; document.getElementById('timer-val').innerText=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

    const soups = [{f:"Ê≤ôÊº†ÈáåÊúâÂçäÊ†πÁÅ´Êü¥„ÄÇ", b:"ÊäΩÁ≠æ„ÄÇ"}, {f:"Êµ∑ÈæüÊ±§„ÄÇ", b:"‰∫∫ËÇâ„ÄÇ"}];
    function nextSoup() { document.getElementById('soup-f').innerText = soups[Math.floor(Math.random()*soups.length)].f; }
</script>
</body>
</html>
